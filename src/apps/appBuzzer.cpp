#include "AppManager.h"

static const uint8_t buzzer_icon[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x80, 0x03, 0x00, 0x00, 0xc0, 0x07, 0x00, 0x00, 0xe0, 0x06, 0x00, 0x00, 0x70, 0x06, 0x00,
    0x00, 0x38, 0x06, 0x00, 0xf8, 0x1f, 0x06, 0x03, 0xfc, 0x0f, 0x06, 0x06, 0x1c, 0x00, 0x66, 0x0c,
    0x0c, 0x00, 0xc6, 0x18, 0x0c, 0x00, 0x86, 0x19, 0x0c, 0x00, 0x06, 0x31, 0x0c, 0x00, 0x06, 0x23,
    0x0c, 0x00, 0x06, 0x22, 0x0c, 0x00, 0x06, 0x23, 0x0c, 0x00, 0x06, 0x31, 0x0c, 0x00, 0x86, 0x11,
    0x1c, 0x00, 0xc6, 0x18, 0xfc, 0x0f, 0x66, 0x0c, 0xf8, 0x1f, 0x06, 0x06, 0x00, 0x38, 0x06, 0x03,
    0x00, 0x70, 0x86, 0x01, 0x00, 0xe0, 0x06, 0x00, 0x00, 0xc0, 0x07, 0x00, 0x00, 0x80, 0x03, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};


class AppBuzzer : public AppBase
{
private:
    /* data */
public:
    AppBuzzer()
    {
        name = "buzzer";
        title = "蜂鸣器";
        description = "蜂鸣器音乐播放器";
        image = buzzer_icon;
        peripherals_requested = PERIPHERALS_SD_BIT;
    }
    void set();
    void setup();
};
static AppBuzzer app;

void AppBuzzer::set(){
    _showInList = hal.pref.getBool(hal.get_char_sha_key(title), true);
}
void AppBuzzer::setup()
{
    while (1)
    {
        const char *path = GUI::fileDialog("请选择要播放的文件", false, "buz");
        if (path == NULL)
        {
            appManager.goBack();
            return;
        }
        buzzer.playFile(path);
        display.display(false); // 全局刷新一次
        while (hal.btnl.isPressing() == false && hal.btnr.isPressing() == false && hal.btnc.isPressing() == false && buzzer.hasNote())
        {
            delay(100);
        }
        if (buzzer.hasNote())
        {
            buzzer.forceStop();
        }
        if (GUI::msgbox_yn("播放已停止", "是否退出播放", "退出", "换文件"))
        {
            break;
        }
    }
    appManager.goBack();
}
